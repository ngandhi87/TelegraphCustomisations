<media-mogul-configuration>
        <config groupname="ProcMigration-full">
		<modules>
			<module ref="Selects records for transfer from source location">
				<class>com.picdar.process2.Acquisition.RecordSelector.RecordSelector</class>
				<config>
					<datasource>classic-lib</datasource>

					<table>photorecord</table>
					<idfield>_urn</idfield>

<naCriteria>(and (ge [photorecord]date_created %%value:yearstart%%0101)(lt [photorecord]date_created %%value:yearstop%%0101))</naCriteria> 

<!-- <naCriteria>(eq [photorecord]_xurn %%value:xurn%%)</naCriteria> -->
					<limit>0</limit>

					<batchsize>%%value:batchsize:100%%</batchsize>
					<action_when_no_match>0</action_when_no_match>
					<dateformat>ddMMyyyy</dateformat>
					<defaultDate>22022005</defaultDate>
<timestampSource>ClassicDataManagerLib</timestampSource>
					<datasource_classname>com.picdar.process2.Acquisition.RecordSelector.NamedAccess.RecSelDataSourceNA</datasource_classname>

				</config>
			</module>
			<module ref="Reads the metadata in from source location">
				<class>com.picdar.process2.Repository.DataReader.NamedAccess.DataReaderNA</class>
				<config>
			        <DataManagerResource>ClassicDataManagerLib</DataManagerResource>
					<SearchManagerResource>ClassicSearchManagerLib</SearchManagerResource>

					<datasource>classic-lib</datasource>
<getPublicationRecords>true</getPublicationRecords>
<childRecordsToRead>versions</childRecordsToRead>
                    <do-store-name>SOURCE_RECORD_DO</do-store-name>
                    <xml-store-name>SOURCE_RECORD_XML</xml-store-name>
<add-field-info>false</add-field-info>
				</config>
			</module>

                        <module ref="Copy xurn into process item">
                        <class>com.picdar.process2.Processing.MetaDataProcessor.MetaDataProcessor</class>
                        <config>
                              <object-name>SOURCE_RECORD_DO</object-name>
                              <empty-action>abort</empty-action>
                              <metadata-processors>
                                    <processor class="com.picdar.process2.Processing.MetaDataProcessor.AttributeToProcessItemObject" ref="CopyTo">
                                           <properties>
                                                 <attribute-name>_xurn</attribute-name>
                                                 <target-object>XURN_FROM_SOURCE</target-object>
                                           </properties>
                                    </processor>
                              </metadata-processors>
                        </config>
                        </module>

                        <module ref="Get count of item in audt table">
                                <class>com.picdar.process2.Repository.JDBCStatement.ProcessItemJDBCStatement</class>
                                <config>

                                        <datasource>default</datasource>
                                        <object-source>SOURCE_RECORD_DO</object-source>
                                        <store_name>EXISTS_IN_DEST_DOA</store_name>
                                        <stores_field_names>no</stores_field_names>
                                        <add_to_process_item>yes</add_to_process_item>  
                                        <use-at>true</use-at>
                                        <statement>SELECT count(eurn) as CNTXURN from audt_libphrec  where eurn = '@@read-from:XURN_FROM_SOURCE@@' and batchid is not null </statement> 
                                </config>
                        </module>
                        <module ref="Transfer item count to test">
                        <class>com.picdar.process2.Processing.MetaDataProcessor.MetaDataProcessor</class>
                        <config>
                              <object-name>EXISTS_IN_DEST_DOA</object-name>
                              <empty-action>abort</empty-action>
                              <metadata-processors>
                                    <processor class="com.picdar.process2.Processing.MetaDataProcessor.AttributeToProcessItemObject" ref="CopyTo">
                                           <properties>
                                                 <attribute-name>CNTXURN</attribute-name>
                                                 <target-object>AUDIT_EXISTS_COUNT</target-object>
                                           </properties>
                                    </processor>
                              </metadata-processors>
                        </config>
                        </module>


			<module ref="Converts to target xml format">
				<class>com.picdar.process2.Processing.XMLTransformer.XMLTransformer</class>
				<config>
                                        <run_conditions rule-process-item="">
                                             <rules>
                                                    <rule name="Exists In Audit">
                                                        <criteria>
                                                            <criterion datatype="number" field="AUDIT_EXISTS_COUNT" operator="eq" value="0"/>
                                                        </criteria>
                                                    </rule>
                                             </rules>
                                        </run_conditions>
					<XMLManagerResource>XMLManager</XMLManagerResource>
					<failureiscritical>true</failureiscritical>
					<!-- dump-xml>true</dump-xml -->
                                        <!-- dump-xml-path>/var/tmp/dump</dump-xml-path-->
					<transform name="TelegraphLibraryMigration">

						<readname>SOURCE_RECORD_XML</readname>
						<storename>TARGET_RECORD_XML</storename>
					</transform>
				</config>
			</module>

			<module ref="Transforms into target data objects">
				<class>com.picdar.process2.Repository.MetadataConverter.MetaDataConverter</class>

				<config>
                                        <run_conditions rule-process-item="">
                                             <rules>
                                                    <rule name="Exists In Audit">
                                                        <criteria>
                                                            <criterion datatype="number" field="AUDIT_EXISTS_COUNT" operator="eq" value="0"/>
                                                        </criteria>
                                                    </rule>
                                             </rules>
                                        </run_conditions>
					<XMLIngestionManagerResource>XMLIngestionManager</XMLIngestionManagerResource>
					<object-name>TARGET_RECORD_XML</object-name>
					<store-name>TARGET_RECORD_DO</store-name>
				</config>
			</module>


			<module ref="Starts transaction">
				<class>com.picdar.process2.Core.TransactionStart</class>
				<config>
                                        <run_conditions rule-process-item="">
                                             <rules>
                                                    <rule name="Exists In Audit">
                                                        <criteria>
                                                            <criterion datatype="number" field="AUDIT_EXISTS_COUNT" operator="eq" value="0"/>
                                                        </criteria>
                                                    </rule>
                                             </rules>
                                        </run_conditions>
					<TransactionManager>TransactionManager</TransactionManager>
				</config>
			</module>

			<module ref="Saves metadata in target location">
				<class>com.picdar.process2.Repository.DataObjectLoader.DataObjectLoader</class>
				<config>
                                        <run_conditions rule-process-item="">
                                             <rules>
                                                    <rule name="Exists In Audit">
                                                        <criteria>
                                                            <criterion datatype="number" field="AUDIT_EXISTS_COUNT" operator="eq" value="0"/>
                                                        </criteria>
                                                    </rule>
                                             </rules>
                                        </run_conditions>
      				<object-name>TARGET_RECORD_DO</object-name>
					<TransactionManager>TransactionManager</TransactionManager>
					<DataManager>DataManager</DataManager>
					<AssetAccess>AssetAccess</AssetAccess>

					<AssetMetadataManager>AssetMetadataManager</AssetMetadataManager>
					<LinkageManager>LinkageManager</LinkageManager>
					<match-existing-records>true</match-existing-records>
					<match-by-primary-key>true</match-by-primary-key>
					<match-fields/>
					<reject-matched-records>false</reject-matched-records>

					<update-matched-records>true</update-matched-records>
					<reject-unmatched-records>false</reject-unmatched-records>
					<create-asset-records>false</create-asset-records>
					<create-asset-versions>false</create-asset-versions>
					<version-action/>
					<metadata-types>picture</metadata-types>

					<child-records-to-delete>NOTICE</child-records-to-delete>
					<store-data-object-properties>
						<picture>
							<UPDATE_LISTS>false</UPDATE_LISTS>
							<THROW_UPDATE_LIST_ERRORS>false</THROW_UPDATE_LIST_ERRORS>
						</picture>
					</store-data-object-properties>

				</config>
			</module>
			<module ref="Commits transaction">

				<class>com.picdar.process2.Core.TransactionEnd</class>
				<config>
                                        <run_conditions rule-process-item="">
                                             <rules>
                                                    <rule name="Exists In Audit">
                                                        <criteria>
                                                            <criterion datatype="number" field="AUDIT_EXISTS_COUNT" operator="eq" value="0"/>
                                                        </criteria>
                                                    </rule>
                                             </rules>
                                        </run_conditions>
					<TransactionManager>TransactionManager</TransactionManager>
				</config>
			</module>

                        <module ref="Update object into purpose build audit table in case record exists, silent error otherwise">
                                <class>com.picdar.process2.Repository.JDBCStatement.DataObjectJDBCStatement</class>
                                <config>

                                        <datasource>default</datasource>
                                        <object-source>SOURCE_RECORD_DO</object-source>
                                        <use-at>true</use-at>
                                        <statement>update audt_libphrec set time_stamp=sysdate, batchid = '%%value:batchid%%' where eurn = '@@read-from:FIELD._xurn@@' </statement> 
                                </config>
                        </module>

                        <module ref="Update object in purpose build audit table, in case record does not exist">
                                <class>com.picdar.process2.Repository.JDBCStatement.DataObjectJDBCStatement</class>
                                <config>
                                        <datasource>default</datasource>
                                        <object-source>SOURCE_RECORD_DO</object-source>
                                        <use-at>true</use-at>
                                        <statement>insert into audt_libphrec ( eUrn, batchid) select '@@read-from:FIELD._xurn@@', '%%value:batchid%%' from dual where not exists ( select 1 from audt_libphrec where eurn = '@@read-from:FIELD._xurn@@' ) </statement> 
                                </config>
                        </module>

		</modules>

		<schedule>
			<scheduletype>manual</scheduletype>
			<runinterval>
				<count>5</count>

				<intervalsize>minute</intervalsize>
			</runinterval>
			<timedschedule>
				<months>1-12</months>
				<dates>1-31</dates>
				<weekdays>1-7</weekdays>
				<hours>22</hours>

				<minutes>0</minutes>
			</timedschedule>
		</schedule>
	</config>
</media-mogul-configuration>