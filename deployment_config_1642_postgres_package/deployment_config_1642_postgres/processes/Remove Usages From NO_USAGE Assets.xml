<media-mogul-configuration>
	<config groupname="FileQueuer">
		<properties>
			<CLASS hidden="true">Maintenance</CLASS>
			<TYPE hidden="true">Usage deleter</TYPE>
			<NAME description="The name of the process">Remove Usages From NO_USAGE Assets</NAME>
			<APP_GROUP description="The group used to run the process">SYSGROUP1</APP_GROUP>
			<NORMALLY_RUNNING description="Should this process be running?" hidden="true">y</NORMALLY_RUNNING>
		<BLOCKED>n</BLOCKED></properties>

		<modules>
			<module ref="Find_Assets">
				<class>com.picdar.process2.Repository.JDBCStatement.JDBCStatement</class>
				<config>
					<datasource>default</datasource>

<!--
We don't need to re-index the affected assets, as indexing doesn't include usages where the NO_USAGE flag is set. So conveniently, all we need to do is actually delete the usages where they shouldn't exist. Based upon that, the SQL required is simply to delete the relevant usages, plus any usage EMD.

NO_USAGE is not indexed by default, so the search may be a little slow, but we will only run over a day (overnight), and the number of matching results should be quite small (just a few hundred). Performance should not be impacted by this.

This is a workaround to resolve a problem where CMIS will add usages to an asset even when the NO_USAGE flag is set (although the usages are not indexed as part of the asset). This process should be resolved once CMIS not honouring the NO_USAGE flag has been corrected.
-->

<!-- delete the usages from the selected assets -->
<statement>delete from dti_usage where asset_id in (select asset_id from asset where no_usage='1')</statement>
<statement>delete from usage where asset_id in (select asset_id from asset where no_usage='1')</statement>
				</config>
			</module>
		</modules>

		<schedule>
			<scheduletype>scheduled</scheduletype>
			<runinterval>
				<count>60</count>
				<intervalsize>minute</intervalsize>
			</runinterval>
			<timedschedule>
				<months>1-12</months>
				<dates>1-31</dates>
				<weekdays>1-7</weekdays>
				<hours>2</hours>
				<minutes>0</minutes>
			</timedschedule>
		</schedule>

	</config>
</media-mogul-configuration>